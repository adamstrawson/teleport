---
title: Dynamic Kubernetes Cluster Registration
description: Register and unregister Kubernetes clusters without restarting a Teleport Kubernetes Service instance.
---

Dynamic Kubernetes cluster registration enables you to manage the Kubernetes
clusters connected to your Teleport cluster without needing to modify the
configuration file of an individual Kubernetes Service instance. This is well
suited for situations in which you have deployed multiple Kubernetes Service
instances or needto add and remove access to Kubernetes clusters regularly. 

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- A Linux host where you will install the Teleport Kubernetes Service.

  <Notice type="tip">

  Our `teleport-kube-agent` Helm chart does not support dynamic Kubernetes
  cluster registration.

  </Notice>

- A Kubernetes cluster to join to your Teleport cluster. 

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Set up the Teleport Kubernetes Service

### Get a join token

Establish trust between your Kubernetes Service instance and your Teleport
cluster by creating a join token for the Kubernetes Service instance:

```code
# Create a join token for the Teleport Kubernetes Service to authenticate
$ TOKEN=$(tctl nodes add --roles=kube --ttl=10000h --format=json | jq -r '.[0]')
$ echo $TOKEN
```

### Install the Teleport Kubernetes Service

Install the Teleport Kubernetes Service on your Linux host or Kubernetes
cluster:

(!docs/pages/includes/install-linux.mdx!)

### Configure the Teleport Kubernetes Service

On the host where you will run the Teleport Kubernetes Service, edit your
configuration file at `/etc/teleport.yaml` to include the following:

```yaml
kubernetes_service:
  enabled: "yes"
  resources:
  - labels:
      "*": "*"
```

This configuration enables your Kubernetes Service instance to connect to any
Kubernetes clusters you register with your Teleport cluster.

<Details title="Selectively watching Kubernetes clusters">

You can configure a Kubernetes Service instance to watch for a subset of
Kubernetes clusters by naming specific labels: 

{/* TODO: How do multiple "labels" items work when each item includes multiple
labels?*/}

```yaml
resources:
- labels:
    "env": "prod"
    "region": "us-east-2"
- labels:
    "env": "test"
```

When you create dynamic Kubernetes cluster resources later in this guide, you
can assign them labels to ensure that only specific Kubernetes Service instances
will watch for them.

</Details>

### Run the Teleport Kubernetes Service

On the host where you will run the Kubernetes Service, execute the following
command:

```code
$ teleport start
```

{/* TODO: is this necessary now that we have systemd support?*/}

## Step 2/3. Authorize your user to access your Kubernetes cluster

{/*TODO: RBAC instructions*/}

## Step 3/3. Manage dynamic Kubernetes cluster resources

### Authorize your user to manage Kubernetes clusters

{/* TODO: edit for Kubernetes*/}

The user creating the dynamic registration needs to have a role with access to the 
database labels and the `db` resource.  In this example role the user can only
create and maintain database services labeled `env: prod` and `engine: postgres`.

```yaml
kind: role
metadata:
  name: dynamicregexample
spec:
  allow:
    db_labels:
      engine: postgres
      env: prod
    rules:
    - resources:
      - db
      verbs:
      - list
      - create
      - read
      - update
      - delete
version: v5
```

### Create a Kubernetes cluster resource

{/* TODO: Modify for Kubernetes*/}

Next define a database resource:

```yaml
kind: db
version: v3
metadata:
  name: example
  description: "Example database"
  labels:
    env: prod
    engine: postgres
spec:
  protocol: "postgres"
  uri: "localhost:5432"
```

To create a database resource, run:

```code
$ tctl create database.yaml
```

After the resource has been created, it will appear among the list of available
databases (in `tsh db ls` or UI) as long as at least one Database Service
instance picks it up according to its label selectors.

To update an existing database resource, run:

```code
$ tctl create -f database.yaml
```

### List Kubernetes cluster resources

{/* TODO*/}

### Delete Kubernetes cluster resources

{/* TODO: Edit the below for Kubernetes*/}

If the updated resource's labels no longer match a particular database agent, it
will unregister and stop proxying it.

To delete a database resource, run:

```code
$ tctl rm db/example
```
